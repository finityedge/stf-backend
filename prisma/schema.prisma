// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  STUDENT
  ADMIN
  BOARD
}

enum ApplicationStatus {
  DRAFT
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  DISBURSED
}

enum EducationLevel {
  HIGH_SCHOOL
  UNIVERSITY
  COLLEGE
  TVET
}

enum ProfileDocumentType {
  NATIONAL_ID
  PASSPORT
  KCSE_CERT
  ADMISSION_LETTER
  STUDENT_ID
  TRANSCRIPT
}

enum ApplicationDocumentType {
  FEE_STRUCTURE
  BALANCE_STATEMENT
  SUPPORT_LETTER
  OTHER_EVIDENCE
}

enum HouseholdIncomeRange {
  BELOW_5K
  FROM_5K_TO_15K
  FROM_15K_TO_30K
  ABOVE_30K
}

enum OrphanStatus {
  BOTH_PARENTS_ALIVE
  SINGLE_ORPHAN
  DOUBLE_ORPHAN
}

enum WhoLivesWith {
  BOTH_PARENTS
  SINGLE_MOTHER
  SINGLE_FATHER
  GUARDIAN
  GRANDPARENT
  ORPHANAGE
  SELF
  OTHER
}

enum NotificationType {
  STATUS_CHANGE
  DEADLINE_REMINDER
  APPLICATION_RECEIVED
  WELCOME
  GENERAL
}

// ==================== USER & AUTHENTICATION ==

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  phone     String    @unique
  password  String
  role      UserRole  @default(STUDENT)
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  studentProfile StudentProfile?
  consentLogs    DataConsentLog[]
  adminNotes     AdminNote[]
  statusChanges  ApplicationStatusHistory[]
  notifications  Notification[]
  reviewScores   ReviewScore[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

// ==================== STUDENT PROFILE ====================

model StudentProfile {
  id                String         @id @default(uuid())
  userId            String         @unique
  fullName          String
  dateOfBirth       DateTime
  gender            String
  ageRange          String?        // For analytics (e.g., "18-22", "23-27")
  nationalIdNumber  String?        @unique
  passportNumber    String?        @unique
  
  // Geographic location
  countyId          String
  subCountyId       String
  wardId            String
  currentResidence  String?
  
  // Institution details
  institutionName   String
  institutionType   EducationLevel
  programmeOrCourse String
  admissionYear     Int
  institutionId     String?
  
  // Family & Guardian information
  whoLivesWith          WhoLivesWith?
  whoLivesWithOther     String?          // Detail if whoLivesWith is OTHER
  guardianName          String?
  guardianPhone         String?
  guardianOccupation    String?
  householdIncomeRange  HouseholdIncomeRange?
  numberOfDependents    Int?
  numberOfSiblings      Int?
  siblingsInSchool      Int?
  
  // Contact
  phoneNumber           String?
  emergencyContactName  String?
  emergencyContactPhone String?
  
  // Vulnerability & Background
  orphanStatus              OrphanStatus?
  disabilityStatus          Boolean        @default(false)
  disabilityType            String?
  kcseGrade                 String?
  previousScholarship       Boolean        @default(false)
  previousScholarshipDetails String?
  
  // Profile completeness
  isComplete        Boolean        @default(false)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  county            County             @relation(fields: [countyId], references: [id])
  subCounty         SubCounty          @relation(fields: [subCountyId], references: [id])
  ward              Ward               @relation(fields: [wardId], references: [id])
  institution       Institution?       @relation(fields: [institutionId], references: [id])
  applications      Application[]
  profileDocuments  ProfileDocument[]

  @@index([nationalIdNumber])
  @@index([passportNumber])
  @@index([countyId])
  @@index([institutionType])
  @@map("student_profiles")
}

// ==================== PROFILE DOCUMENTS (Reusable) ====================

model ProfileDocument {
  id               String             @id @default(uuid())
  studentProfileId String
  documentType     ProfileDocumentType
  originalFilename String
  storedFilename   String             @unique
  filePath         String
  fileSize         Int
  mimeType         String
  uploadedAt       DateTime           @default(now())
  
  // Verification (for future use)
  verifiedByAdmin  Boolean            @default(false)
  verifiedAt       DateTime?
  verifiedBy       String?

  // Relations
  studentProfile   StudentProfile     @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  applicationLinks ApplicationProfileDocumentLink[]

  @@index([studentProfileId])
  @@index([documentType])
  @@map("profile_documents")
}

// ==================== APPLICATION ====================

model Application {
  id                     String            @id @default(uuid())
  applicationNumber      String            @unique  // Auto-generated: STF-YYYY-NNN
  studentProfileId       String
  status                 ApplicationStatus @default(DRAFT)
  
  // Application-specific data (entered during application, NOT from profile)
  outstandingFeesBalance Decimal           @db.Decimal(12, 2)
  hardshipNarrative      String            @db.Text
  currentYearOfStudy     String
  modeOfSponsorship      String[]          // JSON array: ["SELF", "HELB", "PARENT", "GUARDIAN", "OTHER"]
  howSupportingEducation String[]          // JSON array
  currentFeeSituation    String?
  isFeesAffectingStudies Boolean           @default(false)
  hasBeenSentHome        Boolean           @default(false)
  hasMissedExamsOrClasses Boolean          @default(false)
  difficultiesFaced      String[]          // JSON array
  goalForAcademicYear    String?           @db.Text
  referralSource         String?
  
  // Enhanced application fields (Phase 2)
  gpa                        String?
  expectedGraduationDate     DateTime?
  totalAnnualFeeAmount       Decimal?          @db.Decimal(12, 2)
  remainingSemesters         Int?
  appliedToOtherScholarships Boolean           @default(false)
  otherScholarshipsDetails   String?
  communityInvolvement       String?           @db.Text
  careerAspirations          String?           @db.Text
  givingBackPlan             String?           @db.Text
  
  // Snapshot of profile data (immutable once PENDING)
  snapshotFullName       String?
  snapshotDateOfBirth    DateTime?
  snapshotGender         String?
  snapshotNationalId     String?
  snapshotPassportNumber String?
  snapshotInstitution    String?
  snapshotProgramme      String?
  snapshotCounty         String?
  snapshotSubCounty      String?
  snapshotWard           String?
  snapshotPhone          String?
  snapshotEmail          String?
  snapshotEducationLevel EducationLevel?
  
  // Timestamps
  submittedAt            DateTime?
  reviewedAt             DateTime?
  reviewedBy             String?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  
  // Disbursement tracking
  disbursedAmount        Decimal?          @db.Decimal(12, 2)
  disbursedAt            DateTime?
  disbursementNotes      String?

  // Relations
  studentProfile         StudentProfile              @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  applicationPeriod      ApplicationPeriod?           @relation(fields: [applicationPeriodId], references: [id])
  applicationPeriodId    String?
  applicationDocuments   ApplicationDocument[]
  profileDocumentLinks   ApplicationProfileDocumentLink[]
  adminNotes             AdminNote[]
  statusHistory          ApplicationStatusHistory[]
  reviewScores           ReviewScore[]

  @@index([status])
  @@index([studentProfileId])
  @@index([submittedAt])
  @@index([outstandingFeesBalance])
  @@index([studentProfileId, submittedAt(sort: Desc)])
  @@map("applications")
}

// ==================== APPLICATION DOCUMENTS (Per-application) ====================

model ApplicationDocument {
  id               String                 @id @default(uuid())
  applicationId    String
  documentType     ApplicationDocumentType
  originalFilename String
  storedFilename   String                 @unique
  filePath         String
  fileSize         Int
  mimeType         String
  uploadedAt       DateTime               @default(now())

  // Relations
  application      Application            @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([documentType])
  @@map("application_documents")
}

// ==================== APPLICATION-PROFILE DOCUMENT LINK (Bridge Table) ====================

model ApplicationProfileDocumentLink {
  id                String          @id @default(uuid())
  applicationId     String
  profileDocumentId String
  linkedAt          DateTime        @default(now())

  // Relations
  application       Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  profileDocument   ProfileDocument @relation(fields: [profileDocumentId], references: [id], onDelete: Cascade)

  @@unique([applicationId, profileDocumentId])
  @@index([applicationId])
  @@index([profileDocumentId])
  @@map("application_profile_document_links")
}

// ==================== APPLICATION STATUS HISTORY ====================

model ApplicationStatusHistory {
  id             String             @id @default(uuid())
  applicationId  String
  previousStatus ApplicationStatus?
  newStatus      ApplicationStatus
  changedBy      String
  changedAt      DateTime           @default(now())
  reason         String?
  autoGenerated  Boolean            @default(false)

  // Relations
  application    Application        @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  changedByUser  User               @relation(fields: [changedBy], references: [id])

  @@index([applicationId])
  @@index([changedAt])
  @@map("application_status_history")
}

// ==================== ADMIN NOTES ====================

model AdminNote {
  id            String    @id @default(uuid())
  applicationId String
  adminId       String
  noteText      String    @db.Text
  section       String?              // e.g. "financial", "academic", "vulnerability", "general"
  isPrivate     Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Relations
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  admin         User        @relation(fields: [adminId], references: [id])

  @@index([applicationId])
  @@index([adminId])
  @@map("admin_notes")
}

// ==================== DATA CONSENT LOG (KDPA Compliance) ====================

model DataConsentLog {
  id             String   @id @default(uuid())
  userId         String
  ipAddress      String
  consentVersion String
  userAgent      String?
  consentedAt    DateTime @default(now())

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentedAt])
  @@map("data_consent_logs")
}

// ==================== GEOGRAPHIC REFERENCE DATA ====================

model County {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String   @unique
  createdAt DateTime @default(now())

  // Relations
  subCounties     SubCounty[]
  studentProfiles StudentProfile[]

  @@map("counties")
}

model SubCounty {
  id        String   @id @default(uuid())
  countyId  String
  name      String
  code      String   @unique
  createdAt DateTime @default(now())

  // Relations
  county          County           @relation(fields: [countyId], references: [id], onDelete: Cascade)
  wards           Ward[]
  studentProfiles StudentProfile[]

  @@unique([countyId, name])
  @@index([countyId])
  @@map("sub_counties")
}

model Ward {
  id          String   @id @default(uuid())
  subCountyId String
  name        String
  code        String   @unique
  createdAt   DateTime @default(now())

  // Relations
  subCounty       SubCounty        @relation(fields: [subCountyId], references: [id], onDelete: Cascade)
  studentProfiles StudentProfile[]

  @@unique([subCountyId, name])
  @@index([subCountyId])
  @@map("wards")
}

// ==================== INSTITUTION REFERENCE DATA ====================

model Institution {
  id              String         @id @default(uuid())
  name            String         @unique
  type            EducationLevel
  county          String?
  isVerified      Boolean        @default(false)
  createdAt       DateTime       @default(now())

  // Relations
  studentProfiles StudentProfile[]

  @@index([name])
  @@index([type])
  @@map("institutions")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

// ==================== APPLICATION PERIODS ====================

model ApplicationPeriod {
  id           String   @id @default(uuid())
  academicYear String
  title        String
  description  String?  @db.Text
  startDate    DateTime
  endDate      DateTime
  isActive     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
  @@map("application_periods")

  // Relations
  applications Application[]
}

// ==================== REVIEW SCORES ====================

model ReviewScore {
  id              String   @id @default(uuid())
  applicationId   String
  reviewerId      String
  financialNeed   Int               // 1-5
  academicMerit   Int               // 1-5
  communityImpact Int               // 1-5
  vulnerability   Int               // 1-5
  overallScore    Float             // computed average
  comments        String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  reviewer        User        @relation(fields: [reviewerId], references: [id])

  @@unique([applicationId, reviewerId])  // One score per reviewer per application
  @@index([applicationId])
  @@index([reviewerId])
  @@map("review_scores")
}
